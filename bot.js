const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const fs = require('fs-extra');
const path = require('path');

// Configura√ß√µes do bot
const CONFIG = {
    // IMPORTANTE: Substitua pelo n√∫mero do dono (formato: 5511999999999@c.us)
    OWNER_NUMBER: '851553600@c.us', // Altere aqui para seu n√∫mero
    
    // Configura√ß√µes de arquivos
    SESSION_PATH: './session',
    GROUPS_FILE: './grupos.json',
    MESSAGES_FILE: './mensagens.json',
    
    // Configura√ß√µes do bot
    BOT_NAME: 'ü§ñ Bot Divulga√ß√£o',
    PREFIX: '!', // Prefixo dos comandos
};

// Inicializar cliente WhatsApp
const client = new Client({
    authStrategy: new LocalAuth({
        clientId: "bot-divulgacao",
        dataPath: CONFIG.SESSION_PATH
    }),
    puppeteer: {
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--single-process',
            '--disable-gpu'
        ]
    }
});

// Vari√°veis globais
let grupos = [];
let mensagensSalvas = [];

// Fun√ß√µes auxiliares
function carregarDados() {
    try {
        if (fs.existsSync(CONFIG.GROUPS_FILE)) {
            grupos = JSON.parse(fs.readFileSync(CONFIG.GROUPS_FILE, 'utf8'));
        }
        if (fs.existsSync(CONFIG.MESSAGES_FILE)) {
            mensagensSalvas = JSON.parse(fs.readFileSync(CONFIG.MESSAGES_FILE, 'utf8'));
        }
    } catch (error) {
        console.log('Erro ao carregar dados:', error.message);
    }
}

function salvarDados() {
    try {
        fs.writeFileSync(CONFIG.GROUPS_FILE, JSON.stringify(grupos, null, 2));
        fs.writeFileSync(CONFIG.MESSAGES_FILE, JSON.stringify(mensagensSalvas, null, 2));
    } catch (error) {
        console.log('Erro ao salvar dados:', error.message);
    }
}

function isOwner(from) {
    return from === CONFIG.OWNER_NUMBER;
}

function formatarTempo() {
    return new Date().toLocaleString('pt-BR');
}

// Event listeners
client.on('qr', (qr) => {
    console.log('\nüîó Escaneie o QR Code abaixo com seu WhatsApp:');
    qrcode.generate(qr, { small: true });
    console.log('\nüì± Abra o WhatsApp > Menu > Dispositivos conectados > Conectar dispositivo');
});

client.on('ready', async () => {
    console.log('\n‚úÖ Bot conectado com sucesso!');
    console.log(`üì± N√∫mero: ${client.info.wid.user}`);
    console.log(`üë§ Nome: ${client.info.pushname}`);
    console.log(`‚è∞ Conectado em: ${formatarTempo()}`);
    
    carregarDados();
    
    // Atualizar lista de grupos
    const chats = await client.getChats();
    const gruposAtuais = chats.filter(chat => chat.isGroup);
    
    grupos = gruposAtuais.map(grupo => ({
        id: grupo.id._serialized,
        name: grupo.name,
        participants: grupo.participants ? grupo.participants.length : 0,
        addedAt: new Date().toISOString()
    }));
    
    salvarDados();
    console.log(`üìä ${grupos.length} grupos detectados`);
});

client.on('message', async (message) => {
    const from = message.from;
    const body = message.body;
    const isGroup = message.from.endsWith('@g.us');
    
    // Verificar se √© o dono
    if (!isOwner(message.author || from)) {
        return;
    }
    
    // Verificar se √© comando
    if (!body.startsWith(CONFIG.PREFIX)) {
        return;
    }
    
    const args = body.slice(CONFIG.PREFIX.length).trim().split(' ');
    const command = args[0].toLowerCase();
    
    try {
        switch (command) {
            case 'menu':
                await enviarMenu(from);
                break;
                
            case 'grupos':
                await listarGrupos(from);
                break;
                
            case 'divulgar':
                const mensagem = args.slice(1).join(' ');
                if (!mensagem) {
                    await client.sendMessage(from, '‚ùå Use: !divulgar <mensagem>');
                    return;
                }
                await divulgarMensagem(from, mensagem);
                break;
                
            case 'salvar':
                const msgSalvar = args.slice(1).join(' ');
                if (!msgSalvar) {
                    await client.sendMessage(from, '‚ùå Use: !salvar <mensagem>');
                    return;
                }
                await salvarMensagem(from, msgSalvar);
                break;
                
            case 'mensagens':
                await listarMensagens(from);
                break;
                
            case 'usar':
                const indice = parseInt(args[1]);
                if (isNaN(indice)) {
                    await client.sendMessage(from, '‚ùå Use: !usar <n√∫mero>');
                    return;
                }
                await usarMensagemSalva(from, indice);
                break;
                
            case 'deletar':
                const indiceDel = parseInt(args[1]);
                if (isNaN(indiceDel)) {
                    await client.sendMessage(from, '‚ùå Use: !deletar <n√∫mero>');
                    return;
                }
                await deletarMensagem(from, indiceDel);
                break;
                
            case 'status':
                await mostrarStatus(from);
                break;
                
            case 'ajuda':
                await enviarAjuda(from);
                break;
                
            default:
                await client.sendMessage(from, '‚ùå Comando n√£o reconhecido. Use !menu para ver os comandos dispon√≠veis.');
        }
    } catch (error) {
        console.log('Erro ao processar comando:', error);
        await client.sendMessage(from, '‚ùå Erro ao processar comando. Tente novamente.');
    }
});

// Fun√ß√µes dos comandos
async function enviarMenu(chatId) {
    const menu = `
ü§ñ *${CONFIG.BOT_NAME}*
üìã *MENU DE COMANDOS*

*üì¢ DIVULGA√á√ÉO:*
${CONFIG.PREFIX}divulgar <mensagem> - Enviar mensagem para todos os grupos
${CONFIG.PREFIX}grupos - Listar grupos conectados

*üíæ MENSAGENS SALVAS:*
${CONFIG.PREFIX}salvar <mensagem> - Salvar mensagem
${CONFIG.PREFIX}mensagens - Listar mensagens salvas
${CONFIG.PREFIX}usar <n√∫mero> - Usar mensagem salva
${CONFIG.PREFIX}deletar <n√∫mero> - Deletar mensagem salva

*‚ÑπÔ∏è INFORMA√á√ïES:*
${CONFIG.PREFIX}status - Status do bot
${CONFIG.PREFIX}ajuda - Ajuda detalhada
${CONFIG.PREFIX}menu - Este menu

‚ö° *Bot ativo e pronto para uso!*
`;
    
    await client.sendMessage(chatId, menu);
}

async function listarGrupos(chatId) {
    if (grupos.length === 0) {
        await client.sendMessage(chatId, '‚ùå Nenhum grupo encontrado.');
        return;
    }
    
    let lista = `üìä *GRUPOS CONECTADOS (${grupos.length})*\n\n`;
    
    grupos.forEach((grupo, index) => {
        lista += `${index + 1}. *${grupo.name}*\n`;
        lista += `   üë• ${grupo.participants} participantes\n`;
        lista += `   üÜî ${grupo.id}\n\n`;
    });
    
    await client.sendMessage(chatId, lista);
}

async function divulgarMensagem(chatId, mensagem) {
    if (grupos.length === 0) {
        await client.sendMessage(chatId, '‚ùå Nenhum grupo encontrado para divulga√ß√£o.');
        return;
    }
    
    await client.sendMessage(chatId, `üöÄ Iniciando divulga√ß√£o para ${grupos.length} grupos...`);
    
    let sucessos = 0;
    let erros = 0;
    
    for (const grupo of grupos) {
        try {
            await client.sendMessage(grupo.id, mensagem);
            sucessos++;
            
            // Delay entre mensagens para evitar spam
            await new Promise(resolve => setTimeout(resolve, 2000));
        } catch (error) {
            console.log(`Erro ao enviar para ${grupo.name}:`, error.message);
            erros++;
        }
    }
    
    const resultado = `
‚úÖ *DIVULGA√á√ÉO CONCLU√çDA*

üìä *Resultados:*
‚úÖ Sucessos: ${sucessos}
‚ùå Erros: ${erros}
üì± Total de grupos: ${grupos.length}

‚è∞ Conclu√≠do em: ${formatarTempo()}
`;
    
    await client.sendMessage(chatId, resultado);
}

async function salvarMensagem(chatId, mensagem) {
    const novaMensagem = {
        id: mensagensSalvas.length + 1,
        texto: mensagem,
        criadaEm: new Date().toISOString()
    };
    
    mensagensSalvas.push(novaMensagem);
    salvarDados();
    
    await client.sendMessage(chatId, `‚úÖ Mensagem salva com ID: ${novaMensagem.id}`);
}

async function listarMensagens(chatId) {
    if (mensagensSalvas.length === 0) {
        await client.sendMessage(chatId, '‚ùå Nenhuma mensagem salva.');
        return;
    }
    
    let lista = `üíæ *MENSAGENS SALVAS (${mensagensSalvas.length})*\n\n`;
    
    mensagensSalvas.forEach((msg, index) => {
        const preview = msg.texto.length > 50 ? msg.texto.substring(0, 50) + '...' : msg.texto;
        lista += `${index + 1}. ${preview}\n`;
        lista += `   üìÖ ${new Date(msg.criadaEm).toLocaleString('pt-BR')}\n\n`;
    });
    
    lista += `\nüí° Use ${CONFIG.PREFIX}usar <n√∫mero> para enviar uma mensagem salva`;
    
    await client.sendMessage(chatId, lista);
}

async function usarMensagemSalva(chatId, indice) {
    const mensagem = mensagensSalvas[indice - 1];
    
    if (!mensagem) {
        await client.sendMessage(chatId, '‚ùå Mensagem n√£o encontrada.');
        return;
    }
    
    await divulgarMensagem(chatId, mensagem.texto);
}

async function deletarMensagem(chatId, indice) {
    if (indice < 1 || indice > mensagensSalvas.length) {
        await client.sendMessage(chatId, '‚ùå N√∫mero inv√°lido.');
        return;
    }
    
    const mensagemDeletada = mensagensSalvas.splice(indice - 1, 1)[0];
    salvarDados();
    
    await client.sendMessage(chatId, `‚úÖ Mensagem deletada: "${mensagemDeletada.texto.substring(0, 30)}..."`);
}

async function mostrarStatus(chatId) {
    const uptime = process.uptime();
    const horas = Math.floor(uptime / 3600);
    const minutos = Math.floor((uptime % 3600) / 60);
    
    const status = `
üìä *STATUS DO BOT*

ü§ñ *Bot:* ${CONFIG.BOT_NAME}
üì± *N√∫mero:* ${client.info.wid.user}
üë§ *Nome:* ${client.info.pushname}

üìà *Estat√≠sticas:*
üì± Grupos conectados: ${grupos.length}
üíæ Mensagens salvas: ${mensagensSalvas.length}
‚è∞ Tempo ativo: ${horas}h ${minutos}m

üîß *Sistema:*
üìÖ Data/Hora: ${formatarTempo()}
üíª Node.js: ${process.version}
üîÑ Status: ‚úÖ Online
`;
    
    await client.sendMessage(chatId, status);
}

async function enviarAjuda(chatId) {
    const ajuda = `
‚ùì *AJUDA - BOT DIVULGA√á√ÉO*

*üéØ COMO USAR:*

1Ô∏è‚É£ *Divulgar mensagem instant√¢nea:*
   ${CONFIG.PREFIX}divulgar Sua mensagem aqui

2Ô∏è‚É£ *Salvar mensagem para uso posterior:*
   ${CONFIG.PREFIX}salvar Mensagem que ser√° salva

3Ô∏è‚É£ *Ver mensagens salvas:*
   ${CONFIG.PREFIX}mensagens

4Ô∏è‚É£ *Usar mensagem salva:*
   ${CONFIG.PREFIX}usar 1 (n√∫mero da mensagem)

5Ô∏è‚É£ *Ver grupos conectados:*
   ${CONFIG.PREFIX}grupos

*‚ö†Ô∏è IMPORTANTE:*
‚Ä¢ Apenas o dono pode usar comandos
‚Ä¢ O bot precisa estar nos grupos para divulgar
‚Ä¢ H√° delay de 2s entre cada envio
‚Ä¢ Mensagens s√£o salvas automaticamente

*üîß CONFIGURA√á√ÉO:*
‚Ä¢ Edite o n√∫mero do dono no arquivo bot.js
‚Ä¢ Linha: OWNER_NUMBER: 'seu_numero@c.us'

*üìû SUPORTE:*
‚Ä¢ Verifique os logs no terminal
‚Ä¢ Reinicie o bot se necess√°rio
`;
    
    await client.sendMessage(chatId, ajuda);
}

// Inicializar bot
console.log('üöÄ Iniciando Bot de Divulga√ß√£o WhatsApp...');
console.log('üìã Configura√ß√µes:');
console.log(`   üë§ Dono: ${CONFIG.OWNER_NUMBER}`);
console.log(`   üîß Prefixo: ${CONFIG.PREFIX}`);
console.log('');

client.initialize();

